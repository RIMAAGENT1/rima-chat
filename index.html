<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIMA Technical Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a3a6e 0%, #2c5aa0 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            color: #1a3a6e;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }

        .login-box input:focus {
            border-color: #1a3a6e;
        }

        .login-box button {
            width: 100%;
            background: #1a3a6e;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-box button:hover {
            background: #2c5aa0;
        }

        .login-box button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .success-message {
            color: #28a745;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        /* Chat Interface (hidden until authenticated) */
        .chat-app {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-app.authenticated {
            display: flex;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a3a6e 0%, #2c5aa0 100%);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-text {
            color: white;
            flex: 1;
        }

        .header-text h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-text p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .header select {
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            font-size: 0.95rem;
            outline: none;
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
            font-weight: 500;
        }

        .header select:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }

        .header select option {
            background: #1a3a6e;
            color: white;
        }

        /* Deep Search Toggle */
        .deep-search-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: rgba(46, 213, 115, 0.6);
            border-color: rgba(46, 213, 115, 0.8);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Messages */
        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 12px;
            line-height: 1.6;
        }

        .message.user {
            background: #1a3a6e;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .message.assistant h1, .message.assistant h2, .message.assistant h3 {
            color: #1a3a6e;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .message.assistant h1 { font-size: 1.4rem; }
        .message.assistant h2 { font-size: 1.2rem; }
        .message.assistant h3 { font-size: 1.1rem; }

        .message.assistant p { margin-bottom: 10px; }
        .message.assistant ul, .message.assistant ol { margin-left: 20px; margin-bottom: 10px; }
        .message.assistant li { margin-bottom: 5px; }

        .message.assistant table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .message.assistant th, .message.assistant td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .message.assistant th {
            background: #1a3a6e;
            color: white;
        }

        .message.assistant tr:nth-child(even) {
            background: #f8f9fa;
        }

        .message.assistant code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message.assistant blockquote {
            border-left: 4px solid #1a3a6e;
            padding: 12px 20px;
            margin: 15px 0;
            background-color: #f0f7ff;
            color: #1a3a6e;
            font-weight: 500;
            border-radius: 4px;
        }

        .message.assistant strong {
            font-weight: 600;
            color: #1a3a6e;
        }

        /* Input Area */
        .input-area {
            background: white;
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-area input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            border-color: #1a3a6e;
        }

        .input-area button {
            background: #1a3a6e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .input-area button:hover {
            background: #2c5aa0;
        }

        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Loading Animation */
        .loading {
            display: flex;
            gap: 5px;
            padding: 20px;
        }

        .loading span {
            width: 10px;
            height: 10px;
            background: #1a3a6e;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Welcome Message */
        .welcome {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .welcome h2 {
            color: #1a3a6e;
            margin-bottom: 10px;
        }

        /* Status indicator */
        .status {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            padding: 5px;
        }

        .status.connected { color: #28a745; }
        .status.error { color: #dc3545; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>RIMA Technical Assistant</h1>
            <p>Please enter your access code</p>
            <input type="password" id="accessCode" placeholder="Access Code" autofocus>
            <button onclick="authenticate()">Access Chat</button>
            <div id="loginMessage"></div>
        </div>
    </div>

    <!-- Chat Interface (shown after authentication) -->
    <div class="chat-app" id="chatApp">
        <div class="header">
            <div class="header-text">
                <h1>RIMA Technical Assistant</h1>
                <p>We move Post Press</p>
            </div>
            <div class="deep-search-toggle">
                <span>Deep Search</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="deepSearchToggle" onchange="toggleMachineSelector()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <select id="machineSelect" disabled style="opacity: 0.5;">
                <option value="">General Chat</option>
                <option value="RS-10">RS-10</option>
                <option value="RS-11">RS-11</option>
                <option value="RS-12">RS-12</option>
                <option value="RS-33">RS-33</option>
                <option value="SH700">SH700</option>
                <option value="RS-610">RS-610</option>
                <option value="RS-650">RS-650</option>
            </select>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="welcome">
                <h2>Welcome to RIMA Technical Support</h2>
                <p><strong>Regular Chat:</strong> Ask questions about RIMA equipment specifications, dimensions, capabilities, or operation.</p>
                <p><strong>Deep Search Mode:</strong> Toggle on for specialized electrical, PLC programming, and controls questions (requires machine selection).</p>
                <p><em>Supported machines: RS-10, RS-11, RS-12, RS-33, SH700, RS-610, RS-650</em></p>
            </div>
        </div>

        <div class="status" id="status">Ready</div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask a technical question...">
            <button id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // Configuration
        const WEBHOOK_URL = 'https://schaefer.app.n8n.cloud/webhook/rima-chat';

        // Session management
        let authToken = sessionStorage.getItem('rimaAuthToken');
        let sessionId = sessionStorage.getItem('rimaSessionId') || 'session_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('rimaSessionId', sessionId);

        // DOM elements
        const loginContainer = document.getElementById('loginContainer');
        const chatApp = document.getElementById('chatApp');
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');

        // Check if already authenticated
        if (authToken) {
            showChat();
        }

        // Authentication function
        async function authenticate() {
            const accessCode = document.getElementById('accessCode').value;
            const loginMessage = document.getElementById('loginMessage');

            if (!accessCode) {
                loginMessage.className = 'error-message';
                loginMessage.textContent = 'Please enter an access code';
                return;
            }

            loginMessage.className = 'success-message';
            loginMessage.textContent = 'Verifying...';

            try {
                // Validate access code with N8N
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'authenticate',
                        accessCode: accessCode
                    })
                });

                const data = await response.json();

                if (data.authenticated) {
                    // Store token and show chat
                    authToken = accessCode;
                    sessionStorage.setItem('rimaAuthToken', authToken);
                    showChat();
                } else {
                    loginMessage.className = 'error-message';
                    loginMessage.textContent = 'Invalid access code. Please try again.';
                }
            } catch (error) {
                console.error('Auth error:', error);
                loginMessage.className = 'error-message';
                loginMessage.textContent = 'Connection error. Please try again.';
            }
        }

        // Show chat interface
        function showChat() {
            loginContainer.style.display = 'none';
            chatApp.classList.add('authenticated');
            userInput.focus();
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('rimaAuthToken');
            sessionStorage.removeItem('rimaSessionId');
            location.reload();
        }

        // Enter key for login
        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authenticate();
            }
        });

        // Toggle machine selector
        function toggleMachineSelector() {
            const deepSearchToggle = document.getElementById('deepSearchToggle');
            const machineSelect = document.getElementById('machineSelect');

            if (deepSearchToggle.checked) {
                machineSelect.disabled = false;
                machineSelect.style.opacity = '1';
                machineSelect.selectedIndex = 1;
            } else {
                machineSelect.disabled = true;
                machineSelect.style.opacity = '0.5';
                machineSelect.selectedIndex = 0;
            }
        }

        // Enter key to send message
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });

        // Send message function
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            const machineSelect = document.getElementById('machineSelect');
            const deepSearchToggle = document.getElementById('deepSearchToggle');
            const selectedMachine = machineSelect.value;
            const isDeepSearch = deepSearchToggle.checked;

            if (isDeepSearch && (!selectedMachine || selectedMachine === '')) {
                alert('Please select a machine model for Deep Search mode.');
                machineSelect.focus();
                return;
            }

            const welcome = document.querySelector('.welcome');
            if (welcome) welcome.remove();

            let displayMessage = message;
            if (isDeepSearch && selectedMachine) {
                displayMessage = `[${selectedMachine} - Deep Search] ${message}`;
            }
            addMessage(displayMessage, 'user');
            userInput.value = '';

            sendBtn.disabled = true;
            userInput.disabled = true;
            status.textContent = isDeepSearch ? 'Deep searching...' : 'Processing...';
            status.className = 'status';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant loading';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 180000);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Token': authToken
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        action: 'sendMessage',
                        chatInput: message,
                        machine: selectedMachine,
                        deepSearch: isDeepSearch,
                        authToken: authToken
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                loadingDiv.remove();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                let responseText = '';
                if (data.response) {
                    responseText = data.response;
                } else if (data.content && data.content[0] && data.content[0].text) {
                    responseText = data.content[0].text;
                } else if (typeof data === 'string') {
                    responseText = data;
                } else {
                    responseText = JSON.stringify(data, null, 2);
                }

                addMessage(responseText, 'assistant');
                status.textContent = 'Ready';
                status.className = 'status connected';

            } catch (error) {
                loadingDiv.remove();
                clearTimeout(timeoutId);
                console.error('Error:', error);

                let errorMessage = 'Sorry, there was an error connecting to the assistant.';

                if (error.name === 'AbortError') {
                    errorMessage = '⏱️ The request took too long and timed out.';
                } else {
                    errorMessage = '❌ Connection error. Please try again.';
                }

                addMessage(errorMessage, 'assistant');
                status.textContent = 'Error';
                status.className = 'status error';
            }

            sendBtn.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }

        // Add message to chat
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            if (type === 'assistant') {
                if (text.includes('<div') || text.includes('<table>') || text.includes('<h1>') || text.includes('<h2>')) {
                    messageDiv.innerHTML = text;
                } else {
                    messageDiv.innerHTML = marked.parse(text);
                }
            } else {
                messageDiv.textContent = text;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
